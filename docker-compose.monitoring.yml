# Zombi Observability Stack
# Full monitoring stack: Zombi + Prometheus + Grafana + MinIO
#
# Usage:
#   docker-compose -f docker-compose.monitoring.yml up --build -d
#   docker-compose -f docker-compose.monitoring.yml logs -f
#   docker-compose -f docker-compose.monitoring.yml down -v
#
# Endpoints:
#   - Zombi:      http://localhost:8080
#   - Prometheus: http://localhost:9090
#   - Grafana:    http://localhost:3000 (admin/admin)
#   - MinIO:      http://localhost:9001 (minioadmin/minioadmin)

version: '3.8'

services:
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - monitoring

  minio-setup:
    image: minio/mc:RELEASE.2024-01-16T16-06-34Z
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/zombi-events;
      echo 'MinIO bucket created';
      exit 0;
      "
    networks:
      - monitoring

  zombi:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zombi
    ports:
      - "8080:8080"
    environment:
      - ZOMBI_HOST=0.0.0.0
      - ZOMBI_PORT=8080
      - ZOMBI_DATA_DIR=/var/lib/zombi
      - RUST_LOG=zombi=info
      # Cold storage configuration
      - ZOMBI_S3_BUCKET=zombi-events
      - ZOMBI_S3_ENDPOINT=http://minio:9000
      - ZOMBI_S3_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      # Flush configuration for testing (30 second interval)
      - ZOMBI_FLUSH_INTERVAL_SECS=30
      - ZOMBI_ICEBERG_ENABLED=true
      - ZOMBI_SNAPSHOT_THRESHOLD_FILES=1
    volumes:
      - zombi-data:/var/lib/zombi
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health/live || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - monitoring

  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node-exporter
    pid: host
    volumes:
      - /:/host:ro,rslave
    command:
      - '--path.rootfs=/host'
    networks:
      - monitoring

  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - monitoring
    depends_on:
      zombi:
        condition: service_healthy

  grafana:
    image: grafana/grafana:10.2.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/zombi-dashboard.json
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - monitoring
    depends_on:
      - prometheus

networks:
  monitoring:
    driver: bridge

volumes:
  zombi-data:
  prometheus-data:
  grafana-data:
  minio-data:
