# Zombi v0.1 Plan

> Focused plan to ship a working prototype.

---

## Goal

A single-binary event store that:
- Accepts events via HTTP API (JSON + Protobuf)
- Stores in RocksDB (hot)
- Flushes to S3 (cold)
- Consumers can read with offset tracking
- Unified table API (Iceberg-style)

**Not in v0.1:** Replication, consumer groups, Iceberg/Parquet, Helm, docs site.

**Added:** Basic server metrics via `/stats` endpoint for monitoring during testing.

---

## Status: COMPLETE

All v0.1 features implemented and tested.

---

## Week 1: Storage Core

### Tasks

| Task | Description | Status |
|------|-------------|--------|
| Project setup | Cargo workspace, dependencies | DONE |
| `Event` type | Protobuf schema + Rust struct | DONE |
| `SequenceGenerator` | Atomic monotonic counter | DONE |
| `HotStorage` trait | Interface for write/read | DONE |
| RocksDB impl | Implement trait for RocksDB | DONE |

### Deliverables
- [x] `cargo build` works
- [x] `cargo test` passes
- [x] Can write event to RocksDB, read it back

---

## Week 2: S3 Persistence

### Tasks

| Task | Description | Status |
|------|-------------|--------|
| S3 client | Basic put/get with `aws-sdk-s3` | DONE |
| Log segment format | JSON segment structure | DONE |
| `Flusher` | Background task: RocksDB → S3 | DONE |
| Watermark | Track flush progress | DONE |
| Auto-discovery | Flusher discovers topics from RocksDB | DONE |

### Deliverables
- [x] Events flush to S3 every N seconds
- [x] Watermark correctly tracks flushed offset
- [x] Tested with MinIO

---

## Week 3: HTTP API

### Tasks

| Task | Description | Status |
|------|-------------|--------|
| axum setup | Basic HTTP server | DONE |
| `POST /tables/{table}` | Write endpoint (JSON + Protobuf) | DONE |
| `GET /tables/{table}` | Unified read (all partitions) | DONE |
| Idempotency | Dedupe by idempotency_key | DONE |
| Error handling | Proper error responses | DONE |

### Deliverables
- [x] Can write via curl (JSON and Protobuf)
- [x] Can read via curl (unified from hot + cold)
- [x] Returns proper error codes

### API Contract (Implemented)
```
POST /tables/{table}
  Body: JSON {"payload": "...", "partition": 0}
    or: Protobuf Event
  Response: {"offset": 123, "partition": 0, "table": "..."}

GET /tables/{table}?limit=100&since=timestamp
  Response: {"records": [...], "count": N, "has_more": bool}
```

---

## Week 4: Consumer Offsets + Polish

### Tasks

| Task | Description | Status |
|------|-------------|--------|
| Offset storage | Store in RocksDB | DONE |
| `POST /consumers/{group}/commit` | Commit offset | DONE |
| `GET /consumers/{group}/offset` | Fetch offset | DONE |
| Dockerfile | Single binary container | DONE |
| README | Getting started guide | DONE |
| CI | GitHub Actions workflow | DONE |

### Deliverables
- [x] Consumer can commit and resume
- [x] Docker image builds
- [x] README with usage examples

---

## Test Summary

### Property Tests (5)
- [x] `sequences_are_monotonic`
- [x] `no_data_loss`
- [x] `order_preserved`
- [x] `idempotent_writes`
- [x] `partition_isolation`

### Integration Tests (8)
- [x] Health check
- [x] Write record (JSON)
- [x] Write record (Protobuf)
- [x] Read records
- [x] Idempotent write
- [x] Multiple writes and reads
- [x] Consumer offset commit/get
- [x] Stats endpoint

### Unit Tests (18)
- [x] Sequence generator tests
- [x] RocksDB storage tests
- [x] S3 storage tests
- [x] Flusher tests

**Total: 31 tests passing**

---

## Directory Structure (Final)

```
zombi/
├── src/
│   ├── lib.rs
│   ├── main.rs
│   ├── contracts/
│   │   ├── mod.rs
│   │   ├── storage.rs
│   │   ├── cold_storage.rs
│   │   ├── sequence.rs
│   │   ├── flusher.rs
│   │   └── error.rs
│   ├── storage/
│   │   ├── mod.rs
│   │   ├── rocksdb.rs
│   │   ├── s3.rs
│   │   └── sequence.rs
│   ├── flusher/
│   │   └── mod.rs
│   ├── api/
│   │   ├── mod.rs
│   │   └── handlers.rs
│   └── proto/
│       └── (generated)
├── proto/
│   └── event.proto
├── tests/
│   ├── property_tests.rs
│   └── integration_tests.rs
├── .github/
│   └── workflows/
│       └── ci.yml
├── Cargo.toml
├── build.rs
├── Dockerfile
├── README.md
├── SPEC.md
├── CLAUDE.md
└── v0.1_plan.md
```

---

## Success Criteria

v0.1 is done when:

1. [x] `cargo run` starts with RocksDB
2. [x] `cargo run` with S3 env vars enables cold storage
3. [x] `curl -X POST localhost:8080/tables/events -d '...'` returns offset
4. [x] `curl localhost:8080/tables/events` returns events (unified read)
5. [x] Background flusher moves data to S3
6. [x] All 30 tests pass
7. [x] Docker image builds and runs
8. [x] Documentation updated
9. [x] `/stats` endpoint for performance monitoring
