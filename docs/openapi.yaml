openapi: 3.0.3
info:
  title: Zombi API
  version: 0.1.0
  description: HTTP API for Zombi event ingestion and reads.
servers:
  - url: http://localhost:8080
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
  /health/live:
    get:
      summary: Liveness probe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
  /health/ready:
    get:
      summary: Readiness probe
      responses:
        "200":
          description: Ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
        "503":
          description: Not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
  /stats:
    get:
      summary: Server stats
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatsResponse"
  /metrics:
    get:
      summary: Prometheus metrics
      responses:
        "200":
          description: OK
          content:
            text/plain:
              schema:
                type: string
  /tables/{table}:
    post:
      summary: Write a record
      parameters:
        - $ref: "#/components/parameters/TableParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WriteRecordRequest"
          application/x-protobuf:
            schema:
              type: string
              format: binary
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WriteRecordResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    get:
      summary: Read records (hot buffer; use Iceberg for analytics)
      description: Reads from the RocksDB hot buffer only. For production analytics, query Iceberg tables directly via Spark/Trino/DuckDB.
      parameters:
        - $ref: "#/components/parameters/TableParam"
        - name: since
          in: query
          required: false
          schema:
            type: integer
            format: int64
          description: Filter by timestamp_ms
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadRecordsResponse"
  /tables/{table}/bulk:
    post:
      summary: Bulk write records
      parameters:
        - $ref: "#/components/parameters/TableParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BulkWriteRequest"
          application/x-protobuf:
            schema:
              type: string
              format: binary
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkWriteResponse"
  /consumers/{group}/commit:
    post:
      summary: Commit a consumer group offset
      description: "Deprecated: will be removed in a future version. Migrate to Iceberg-native reads."
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/GroupParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommitOffsetRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommitOffsetResponse"
  /consumers/{group}/offset:
    get:
      summary: Get a consumer group offset
      description: "Deprecated: will be removed in a future version. Migrate to Iceberg-native reads."
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/GroupParam"
        - name: topic
          in: query
          required: true
          schema:
            type: string
        - name: partition
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetOffsetResponse"
  /tables/{table}/metadata:
    get:
      summary: Table metadata
      parameters:
        - $ref: "#/components/parameters/TableParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TableMetadataResponse"
  /tables/{table}/flush:
    post:
      summary: Force flush to cold storage
      description: Currently returns status "not_implemented" until the flusher is wired.
      parameters:
        - $ref: "#/components/parameters/TableParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlushResponse"
  /tables/{table}/compact:
    post:
      summary: Trigger compaction
      description: Currently returns status "not_implemented" until the compactor is wired.
      parameters:
        - $ref: "#/components/parameters/TableParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompactResponse"
components:
  parameters:
    TableParam:
      name: table
      in: path
      description: "Table name. Must start with a letter, contain only alphanumeric, underscore, or hyphen characters, and be at most 128 characters."
      required: true
      schema:
        type: string
        pattern: "^[a-zA-Z][a-zA-Z0-9_-]{0,127}$"
    GroupParam:
      name: group
      in: path
      required: true
      schema:
        type: string
  schemas:
    WriteRecordRequest:
      type: object
      properties:
        payload:
          type: string
        partition:
          type: integer
          default: 0
        timestamp_ms:
          type: integer
          format: int64
        idempotency_key:
          type: string
      required:
        - payload
    WriteRecordResponse:
      type: object
      properties:
        offset:
          type: integer
          format: int64
        partition:
          type: integer
        table:
          type: string
    BulkWriteRecord:
      type: object
      properties:
        payload:
          type: string
        partition:
          type: integer
          default: 0
        timestamp_ms:
          type: integer
          format: int64
        idempotency_key:
          type: string
      required:
        - payload
    BulkWriteRequest:
      type: object
      properties:
        records:
          type: array
          items:
            $ref: "#/components/schemas/BulkWriteRecord"
      required:
        - records
    BulkWriteResponse:
      type: object
      properties:
        offsets:
          type: array
          items:
            type: integer
            format: int64
        count:
          type: integer
        table:
          type: string
    RecordResponse:
      type: object
      properties:
        payload:
          type: string
        timestamp_ms:
          type: integer
          format: int64
    ReadRecordsResponse:
      type: object
      properties:
        records:
          type: array
          items:
            $ref: "#/components/schemas/RecordResponse"
        count:
          type: integer
        has_more:
          type: boolean
    CommitOffsetRequest:
      type: object
      properties:
        topic:
          type: string
        partition:
          type: integer
          default: 0
        offset:
          type: integer
          format: int64
      required:
        - topic
        - offset
    CommitOffsetResponse:
      type: object
      properties:
        group:
          type: string
        topic:
          type: string
        partition:
          type: integer
        offset:
          type: integer
          format: int64
    GetOffsetResponse:
      type: object
      properties:
        group:
          type: string
        topic:
          type: string
        partition:
          type: integer
        offset:
          type: integer
          format: int64
          nullable: true
    TableMetadataResponse:
      type: object
      properties:
        table:
          type: string
        storage_type:
          type: string
        iceberg_enabled:
          type: boolean
        metadata_location:
          type: string
          nullable: true
        bucket:
          type: string
          nullable: true
        base_path:
          type: string
          nullable: true
    FlushResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
    CompactResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
    ReadinessResponse:
      type: object
      properties:
        status:
          type: string
        hot_storage:
          $ref: "#/components/schemas/ComponentHealth"
        cold_storage:
          $ref: "#/components/schemas/ComponentHealth"
        backpressure:
          $ref: "#/components/schemas/BackpressureHealth"
    ComponentHealth:
      type: object
      properties:
        status:
          type: string
        error:
          type: string
          nullable: true
    BackpressureHealth:
      type: object
      properties:
        status:
          type: string
        inflight_writes:
          type: integer
        inflight_bytes:
          type: integer
          format: int64
        max_inflight_bytes:
          type: integer
          format: int64
    StatsResponse:
      type: object
      properties:
        uptime_secs:
          type: number
        writes:
          $ref: "#/components/schemas/WriteStats"
        reads:
          $ref: "#/components/schemas/ReadStats"
        errors_total:
          type: integer
          format: int64
    WriteStats:
      type: object
      properties:
        total:
          type: integer
          format: int64
        bytes_total:
          type: integer
          format: int64
        rate_per_sec:
          type: number
        avg_latency_us:
          type: number
    ReadStats:
      type: object
      properties:
        total:
          type: integer
          format: int64
        records_total:
          type: integer
          format: int64
        rate_per_sec:
          type: number
        avg_latency_us:
          type: number
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
